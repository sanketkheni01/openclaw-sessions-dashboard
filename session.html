<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Session — OpenClaw</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}

:root{
  --hull:#0a0c10;
  --panel:#0e1117;
  --shelf:#141820;
  --rack:#1a1f2a;
  --wire:rgba(255,255,255,.06);
  --wire-mid:rgba(255,255,255,.09);
  --wire-bright:rgba(255,255,255,.14);
  --wire-focus:rgba(229,149,74,.4);
  --ink:#e2e4e9;
  --ink-2:#9ca3af;
  --ink-3:#6b7280;
  --ink-4:#3d4452;
  --amber:#e5954a;
  --amber-dim:rgba(229,149,74,.15);
  --amber-glow:rgba(229,149,74,.08);
  --led-green:#4ade80;
  --led-yellow:#facc15;
  --led-red:#f87171;
  --led-blue:#60a5fa;
  --mono:'JetBrains Mono',monospace;
  --sans:'JetBrains Mono',-apple-system,sans-serif;
  --radius:3px;
}

body{
  font-family:var(--mono);
  background:var(--hull);
  color:var(--ink);
  height:100dvh;
  display:flex;flex-direction:column;
  overflow:hidden;
  font-size:12px;
  -webkit-font-smoothing:antialiased;
}

.header{
  padding:4px 12px;
  border-bottom:1px solid var(--wire);
  background:var(--shelf);
  display:flex;justify-content:space-between;align-items:center;
  flex-shrink:0;
  height:32px;
}
.header-left{display:flex;align-items:center;gap:8px;min-width:0;flex:1}
.header-title{font-size:11px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.header-meta{font-size:9px;color:var(--ink-4);display:flex;gap:6px;align-items:center;flex-wrap:wrap;font-variant-numeric:tabular-nums}
.back-link{font-size:10px;color:var(--amber);text-decoration:none;opacity:.7;flex-shrink:0}
.back-link:hover{opacity:1}
.header-controls{display:flex;gap:3px;align-items:center;flex-shrink:0}

.badge{font-size:9px;padding:0px 4px;border-radius:2px;border:1px solid;text-transform:uppercase;letter-spacing:.3px}
.badge-subagent{background:rgba(229,149,74,.05);color:rgba(229,149,74,.7);border-color:rgba(229,149,74,.2)}
.badge-main{background:rgba(74,222,128,.05);color:rgba(74,222,128,.7);border-color:rgba(74,222,128,.2)}
.badge-cron,.badge-cron-run{background:rgba(250,204,21,.04);color:rgba(250,204,21,.6);border-color:rgba(250,204,21,.15)}
.badge-telegram,.badge-group{background:rgba(96,165,250,.05);color:rgba(96,165,250,.7);border-color:rgba(96,165,250,.2)}
.badge-other{background:transparent;color:var(--ink-3);border-color:var(--wire)}

.panel-tabs{display:flex;gap:0;border-bottom:1px solid var(--wire);flex-shrink:0;background:var(--hull);padding:0 8px}
.panel-tab{padding:4px 10px;font-size:10px;color:var(--ink-4);background:none;border:none;border-bottom:1px solid transparent;cursor:pointer;transition:all .12s;font-family:var(--mono);text-transform:uppercase;letter-spacing:.5px}
.panel-tab:hover{color:var(--ink-2)}
.panel-tab.active{color:var(--amber);border-bottom-color:var(--amber)}

.log-container{
  flex:1;overflow-y:auto;padding:8px 12px;
  font-size:12px;
  scroll-behavior:smooth;
}

.log-entry{margin:8px 0;padding-left:10px;border-left:2px solid var(--wire)}
.log-entry.role-user{border-color:rgba(96,165,250,.4)}
.log-entry.role-assistant{border-color:rgba(229,149,74,.4)}
.log-entry.role-tool{border-color:rgba(250,204,21,.25)}

.log-header{display:flex;align-items:center;margin-bottom:3px;gap:6px}
.log-role{
  font-size:9px;font-weight:600;text-transform:uppercase;
  padding:0px 4px;border-radius:2px;border:1px solid;
  letter-spacing:.5px;
}
.role-user{background:rgba(96,165,250,.08);color:rgba(96,165,250,.7);border-color:rgba(96,165,250,.15)}
.role-assistant{background:rgba(229,149,74,.08);color:rgba(229,149,74,.7);border-color:rgba(229,149,74,.15)}
.role-tool{background:rgba(250,204,21,.06);color:rgba(250,204,21,.6);border-color:rgba(250,204,21,.12)}

.log-timestamp{font-size:9px;color:var(--ink-4);margin-left:auto;font-variant-numeric:tabular-nums}
.log-content{margin-bottom:3px}

.log-text{font-size:12px;line-height:1.5;white-space:pre-wrap;word-break:break-word;color:var(--ink-2)}
.log-text h1,.log-text h2,.log-text h3{margin:6px 0 3px;color:var(--ink)}
.log-text h1{font-size:16px}.log-text h2{font-size:14px}.log-text h3{font-size:13px}
.log-text p{margin:3px 0}
.log-text ul,.log-text ol{margin:3px 0;padding-left:18px}
.log-text code{background:var(--shelf);padding:1px 3px;border-radius:2px;font-family:var(--mono);font-size:11px}
.log-text pre{background:var(--hull);padding:6px 10px;border-radius:var(--radius);overflow-x:auto;margin:6px 0;border:1px solid var(--wire)}
.log-text pre code{background:none;padding:0}
.log-text a{color:var(--amber);text-decoration:none}
.log-text a:hover{text-decoration:underline}

.tool-call{background:var(--shelf);border:1px solid var(--wire);border-radius:var(--radius);margin:6px 0;overflow:hidden}
.tool-header{padding:4px 8px;background:var(--rack);border-bottom:1px solid var(--wire);display:flex;justify-content:space-between;align-items:center;cursor:pointer}
.tool-name{font-size:10px;color:var(--ink-2);font-weight:500;display:flex;align-items:center;gap:4px}
.tool-toggle{color:var(--ink-4);transition:transform .12s;font-size:9px}
.tool-call.expanded .tool-toggle{transform:rotate(180deg)}
.tool-content{display:none}
.tool-call.expanded .tool-content{display:block}
.tool-args,.tool-result{padding:6px 8px;font-size:10px;font-family:var(--mono)}
.tool-args{color:var(--ink-3);background:var(--hull);white-space:pre-wrap;word-break:break-all;border-bottom:1px solid var(--wire)}
.tool-result{color:var(--ink-2);background:var(--panel)}
.tool-pending{padding:6px 8px;color:var(--ink-4);font-style:italic;font-size:10px;background:var(--hull)}

.copy-btn{background:transparent;border:1px solid var(--wire);color:var(--ink-4);padding:1px 6px;border-radius:2px;cursor:pointer;font-size:9px;transition:color .12s;font-family:var(--mono)}
.copy-btn:hover{color:var(--ink-2)}

.image-preview{max-width:100%;max-height:300px;border-radius:var(--radius);border:1px solid var(--wire);margin:6px 0;cursor:pointer;transition:border-color .12s}
.image-preview:hover{border-color:var(--wire-mid)}

.thinking-block{background:var(--shelf);border:1px solid var(--wire);border-radius:var(--radius);padding:6px 8px;margin:6px 0;font-style:italic;color:var(--ink-3);font-size:10px}

.log-meta{display:flex;gap:6px;margin-top:3px;font-size:9px;color:var(--ink-4);font-variant-numeric:tabular-nums}
.log-cost{color:var(--amber);font-weight:600;background:rgba(229,149,74,.08);padding:0px 3px;border-radius:2px}
.log-tokens{color:var(--ink-4)}
.log-model{color:var(--ink-4)}

.send-bar{
  padding:6px 12px;border-top:1px solid var(--wire);
  background:var(--panel);display:flex;gap:6px;flex-shrink:0;align-items:center;
}
.send-bar input{
  flex:1;padding:5px 8px;
  background:var(--shelf);border:1px solid var(--wire);
  border-radius:var(--radius);color:var(--ink);font-size:11px;
  font-family:var(--mono);outline:none;
}
.send-bar input:focus{border-color:var(--amber)}
.send-bar input::placeholder{color:var(--ink-4)}
.send-btn{
  width:28px;height:28px;border-radius:var(--radius);
  background:var(--amber);border:none;color:var(--hull);
  cursor:pointer;display:flex;align-items:center;justify-content:center;
  transition:opacity .12s;flex-shrink:0;
}
.send-btn:hover{opacity:.85}

.btn{padding:2px 8px;background:transparent;border:1px solid var(--wire);border-radius:var(--radius);color:var(--ink-3);cursor:pointer;font-size:10px;font-family:var(--mono)}
.btn:hover{border-color:var(--wire-mid);color:var(--ink-2)}

.subagents-container{flex:1;overflow-y:auto;padding:12px;display:none}
.subagent-card{background:var(--shelf);border:1px solid var(--wire);border-radius:var(--radius);padding:8px 10px;margin-bottom:4px;cursor:pointer;transition:border-color .12s}
.subagent-card:hover{border-color:var(--wire-mid)}
.subagent-card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:3px}
.subagent-card-name{font-size:11px;font-weight:500;color:var(--ink)}
.subagent-card-meta{font-size:9px;color:var(--ink-4);display:flex;gap:6px;flex-wrap:wrap}
.subagent-card-status{font-size:9px;padding:0px 4px;border-radius:2px}
.subagent-card-status.running{background:rgba(74,222,128,.1);color:rgba(74,222,128,.8)}
.subagent-card-status.completed{background:rgba(96,165,250,.1);color:rgba(96,165,250,.8)}
.subagent-card-status.error{background:rgba(248,113,113,.1);color:rgba(248,113,113,.8)}

.loading{text-align:center;padding:32px;color:var(--ink-4);font-size:11px}
.empty-state{text-align:center;padding:32px;color:var(--ink-4)}

.toast-container{position:fixed;top:8px;right:8px;z-index:999;display:flex;flex-direction:column;gap:4px}
.toast{padding:6px 10px;border-radius:var(--radius);font-size:10px;background:var(--shelf);border:1px solid var(--wire);color:var(--ink-2);animation:fadeIn .15s}
.toast.success{border-color:rgba(74,222,128,.3);color:rgba(74,222,128,.8)}
.toast.error{border-color:rgba(248,113,113,.3);color:rgba(248,113,113,.8)}
@keyframes fadeIn{from{opacity:0;transform:translateY(-6px)}to{opacity:1;transform:translateY(0)}}
</style>
</head>
<body>

<div class="header">
  <div class="header-left">
    <a href="/" class="back-link">← sessions</a>
    <div class="header-title" id="sessionTitle">loading…</div>
    <div class="header-meta" id="sessionMeta"></div>
  </div>
  <div class="header-controls">
    <button class="btn" onclick="copyTranscript()">copy</button>
    <button class="btn" onclick="location.reload()">↻</button>
  </div>
</div>

<div class="panel-tabs" id="panelTabs" style="display:none">
  <button class="panel-tab active" data-tab="transcript" onclick="switchTab('transcript',this)">transcript</button>
  <button class="panel-tab" data-tab="subagents" onclick="switchTab('subagents',this)">sub-agents</button>
</div>

<div class="log-container" id="logContainer">
  <div class="loading">loading session…</div>
</div>
<div class="subagents-container" id="subagentsContainer"></div>

<div class="send-bar" id="sendBar">
  <input type="text" id="sendInput" placeholder="send message to session…" autocomplete="off"
    onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendMessage()}">
  <button class="send-btn" onclick="sendMessage()">
    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 2L11 13"/><path d="M22 2L15 22L11 13L2 9L22 2Z"/></svg>
  </button>
</div>

<div class="toast-container" id="toastContainer"></div>

<script>
const sessionKey = decodeURIComponent(location.pathname.replace('/session/', ''));
let session = null;
let allSessions = [];
let transcriptEntries = [];
let transcriptTotal = 0;
let transcriptOffset = 0;

function escapeHtml(t) { if (!t) return ''; const d = document.createElement('div'); d.textContent = t; return d.innerHTML; }

function formatTime(ts) {
  if (!ts) return '—';
  const diff = Date.now() - ts;
  if (diff < 60000) return Math.floor(diff/1000) + 's';
  if (diff < 3600000) return Math.floor(diff/60000) + 'm';
  if (diff < 86400000) return Math.floor(diff/3600000) + 'h';
  return Math.floor(diff/86400000) + 'd';
}

function formatTimestamp(ts) {
  if (!ts) return '';
  return new Date(ts).toLocaleTimeString('en-US', {hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false});
}

function formatBadgeLabel(type) {
  const labels = {main:'main',group:'group',telegram:'telegram',cron:'cron','cron-run':'run',subagent:'sub-agent',other:'other'};
  return labels[type] || type;
}

let topicNamesMap = {};

function getSessionName(s) {
  if (s.label) return s.label;
  const topicMatch = s.key.match(/topic:(\d+)/);
  if (topicMatch) {
    const topicId = topicMatch[1];
    const topicName = topicNamesMap[topicId];
    if (topicName) return topicName;
    return s.subject ? `${s.subject} #${topicId}` : `Topic ${topicId}`;
  }
  if (s.subject) return s.subject;
  if (s.displayName) return s.displayName.replace('telegram:', '').replace('g-', 'Group ');
  if (s.key.includes(':main:main')) return 'Main DM';
  const cronMatch = s.key.match(/cron:(.{8})/);
  if (cronMatch) return `Cron ${cronMatch[1]}`;
  return s.key.split(':').slice(-2).join(':');
}

function showToast(type, title, msg) {
  const c = document.getElementById('toastContainer');
  const t = document.createElement('div');
  t.className = `toast ${type}`;
  t.textContent = `${title}: ${msg}`;
  c.appendChild(t);
  setTimeout(() => t.remove(), 3000);
}

function toggleToolCall(element) { element.classList.toggle('expanded'); }

function copyText(text) {
  navigator.clipboard.writeText(text).then(() => showToast('success', 'Copied', 'Text copied'))
    .catch(() => showToast('error', 'Error', 'Failed to copy'));
}

function switchTab(tab, btn) {
  document.querySelectorAll('.panel-tab').forEach(b => b.classList.remove('active'));
  if (btn) btn.classList.add('active');
  document.getElementById('logContainer').style.display = tab === 'transcript' ? '' : 'none';
  document.getElementById('sendBar').style.display = tab === 'transcript' ? '' : 'none';
  document.getElementById('subagentsContainer').style.display = tab === 'subagents' ? '' : 'none';
  if (tab === 'subagents') renderSubagents();
}

function renderSubagents() {
  const container = document.getElementById('subagentsContainer');
  const isMain = session.key.endsWith(':main');
  const agents = allSessions.filter(s => {
    if (s.sessionType !== 'subagent') return false;
    if (isMain) return true;
    if (s.parentKey === session.key) return true;
    const childKeys = (session.children || []).map(c => c.key);
    if (childKeys.includes(s.key)) return true;
    return false;
  }).sort((a, b) => (b.updatedAt || 0) - (a.updatedAt || 0));

  if (!agents.length) {
    container.innerHTML = '<div class="empty-state"><p>no sub-agents found</p></div>';
    return;
  }

  container.innerHTML = `<div style="font-size:9px;color:var(--ink-4);margin-bottom:6px;text-transform:uppercase;letter-spacing:.5px">${agents.length} sub-agent${agents.length !== 1 ? 's' : ''}</div>` +
    agents.map(s => {
      const status = s.status === 'running' ? 'running' : (s.abortedLastRun ? 'error' : 'completed');
      const statusLabel = status === 'running' ? '● running' : (status === 'error' ? '✗ error' : '✓ done');
      const name = s.label || s.displayName || s.key.split(':').pop().slice(0, 8);
      const tokens = s.totalTokens ? `${(s.totalTokens/1000).toFixed(1)}k tok` : '';
      const model = s.model ? s.model.split('/').pop() : '';
      const ago = s.updatedAt ? formatTime(s.updatedAt) + ' ago' : '';
      return `<div class="subagent-card" onclick="window.open('/session/${encodeURIComponent(s.key)}','_blank')">
        <div class="subagent-card-header">
          <div class="subagent-card-name">${escapeHtml(name)}</div>
          <span class="subagent-card-status ${status}">${statusLabel}</span>
        </div>
        <div class="subagent-card-meta">
          ${model ? `<span>${escapeHtml(model)}</span>` : ''}
          ${tokens ? `<span>${tokens}</span>` : ''}
          ${ago ? `<span>${ago}</span>` : ''}
        </div>
      </div>`;
    }).join('');
}

function renderTranscript(entries) {
  const container = document.getElementById('logContainer');
  if (!entries.length) { container.innerHTML = '<div class="empty-state"><p>no entries</p></div>'; return; }

  const resultMap = {};
  entries.forEach(entry => {
    (entry.content || []).forEach(c => { if (c.type === 'result' && c.id) resultMap[c.id] = c; });
  });
  const renderedResults = new Set();

  const html = entries.map(entry => {
    const role = entry.role || 'system';
    let contentHtml = '';
    (entry.content || []).forEach(c => {
      if (c.type === 'tool') {
        const result = resultMap[c.id];
        let resultHtml;
        if (result) {
          renderedResults.add(c.id);
          resultHtml = `<div class="tool-content">
            <div class="tool-args">${escapeHtml(JSON.stringify(c.args || {}, null, 2))}</div>
            <div class="tool-result">
              <div style="display:flex;justify-content:space-between;margin-bottom:3px">
                <span style="color:rgba(74,222,128,.7);font-weight:600;font-size:9px;letter-spacing:.5px">RESULT</span>
                <button class="copy-btn" onclick="event.stopPropagation();copyText(this.closest('.tool-result').textContent)">copy</button>
              </div>
              ${escapeHtml(result.text || '(empty)')}
            </div>
          </div>`;
        } else {
          resultHtml = `<div class="tool-content">
            <div class="tool-args">${escapeHtml(JSON.stringify(c.args || {}, null, 2))}</div>
            <div class="tool-pending">waiting for result…</div>
          </div>`;
        }
        contentHtml += `<div class="tool-call" onclick="toggleToolCall(this)">
          <div class="tool-header">
            <div class="tool-name">${escapeHtml(c.name)}</div>
            <div class="tool-toggle">▾</div>
          </div>
          ${resultHtml}
        </div>`;
      } else if (c.type === 'result' && !renderedResults.has(c.id)) {
        contentHtml += `<div class="tool-call expanded">
          <div class="tool-header">
            <div class="tool-name">${escapeHtml(c.name)}</div>
            <button class="copy-btn" onclick="event.stopPropagation();copyText(this.closest('.tool-call').querySelector('.tool-result')?.textContent||'')">copy</button>
          </div>
          <div class="tool-content"><div class="tool-result">${escapeHtml(c.text || '(empty)')}</div></div>
        </div>`;
      } else if (c.type === 'text') {
        contentHtml += `<div class="log-text">${marked.parse(c.text || '')}</div>
          <button class="copy-btn" onclick="copyText(${JSON.stringify(c.text || '')})">copy</button>`;
      } else if (c.type === 'image') {
        contentHtml += `<img class="image-preview" src="${escapeHtml(c.url)}"
          onclick="window.open('${escapeHtml(c.url)}','_blank')"
          onerror="this.outerHTML='<span style=color:var(--ink-4)>Image: '+this.src+'</span>'" />`;
      } else if (c.type === 'thinking') {
        contentHtml += `<div class="thinking-block">${escapeHtml(c.text)}</div>`;
      }
    });
    if (!contentHtml.trim()) return '';
    const metaHtml = [];
    if (entry.model) metaHtml.push(`<span class="log-model">${entry.model}</span>`);
    if (entry.cost > 0) metaHtml.push(`<span class="log-cost">$${entry.cost.toFixed(4)}</span>`);
    if (entry.tokens && (entry.tokens.in || entry.tokens.out)) {
      metaHtml.push(`<span class="log-tokens">${entry.tokens.in}→${entry.tokens.out}</span>`);
      if (entry.tokens.cache) metaHtml.push(`<span class="log-tokens">${entry.tokens.cache} cached</span>`);
    }
    return `<div class="log-entry role-${role}">
      <div class="log-header">
        <div class="log-role role-${role}">${role.toUpperCase()}</div>
        <div class="log-timestamp">${formatTimestamp(entry.ts)}</div>
      </div>
      ${contentHtml}
      ${metaHtml.length ? `<div class="log-meta">${metaHtml.join(' ')}</div>` : ''}
    </div>`;
  }).filter(h => h).join('');

  container.innerHTML = html;
  setTimeout(() => { container.scrollTop = container.scrollHeight; }, 100);
}

async function loadTranscript(sessionId) {
  const container = document.getElementById('logContainer');
  container.innerHTML = '<div class="loading">loading transcript…</div>';
  try {
    const r = await fetch(`/data/transcript/${sessionId}?limit=200&t=` + Date.now());
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    const txt = await r.text();
    if (!txt) throw new Error('Empty response');
    const d = JSON.parse(txt);
    if (d.error) { container.innerHTML = `<div class="loading">${d.error}</div>`; return; }
    transcriptEntries = d.entries || [];
    transcriptTotal = d.total || transcriptEntries.length;
    transcriptOffset = d.offset || 0;
    renderTranscript(transcriptEntries);
    container.scrollTop = container.scrollHeight;
    if (transcriptOffset > 0) setupInfiniteScroll(sessionId, container);
  } catch(e) { container.innerHTML = `<div class="loading">failed: ${e.message}</div>`; }
}

let _loadingMore = false;
function setupInfiniteScroll(sessionId, container) {
  container.addEventListener('scroll', async function handler() {
    if (_loadingMore || transcriptOffset <= 0 || container.scrollTop > 100) return;
    _loadingMore = true;
    const prevHeight = container.scrollHeight;
    const loadOffset = Math.max(0, transcriptOffset - 100);
    const loadLimit = transcriptOffset - loadOffset;
    try {
      const r = await fetch(`/data/transcript/${sessionId}?offset=${loadOffset}&limit=${loadLimit}`);
      if (!r.ok) { _loadingMore = false; return; }
      const d = await r.json();
      if (d.entries?.length) {
        transcriptEntries = [...d.entries, ...transcriptEntries];
        transcriptOffset = loadOffset;
        renderTranscript(transcriptEntries);
        container.scrollTop = container.scrollHeight - prevHeight;
        if (transcriptOffset <= 0) container.removeEventListener('scroll', handler);
      }
    } catch(e) {}
    _loadingMore = false;
  });
}

async function refreshTranscript(sessionId) {
  try {
    const r = await fetch(`/data/transcript/${sessionId}?limit=100`);
    if (!r.ok) return;
    const text = await r.text();
    if (!text) return;
    const d = JSON.parse(text);
    if (!d.entries) return;
    const container = document.getElementById('logContainer');
    const wasAtBottom = container.scrollHeight - container.scrollTop - container.clientHeight < 100;
    const newTotal = d.total || 0;
    if (newTotal !== transcriptTotal) {
      const oldPrefix = transcriptEntries.slice(0, transcriptEntries.length - (transcriptTotal - (d.offset || 0)));
      transcriptEntries = [...oldPrefix, ...d.entries];
      transcriptTotal = newTotal;
      renderTranscript(transcriptEntries);
      if (wasAtBottom) container.scrollTop = container.scrollHeight;
    }
  } catch(e) {}
}

function copyTranscript() {
  const text = transcriptEntries.map(e => {
    const role = e.role || 'unknown';
    let content = '';
    if (Array.isArray(e.content)) content = e.content.map(b => b.text || '').filter(Boolean).join('\n');
    else content = e.content || '';
    return `[${role}] ${content}`;
  }).join('\n\n');
  navigator.clipboard.writeText(text).then(() => showToast('success','Copied','Transcript copied'));
}

async function sendMessage() {
  const input = document.getElementById('sendInput');
  const btn = input.nextElementSibling;
  const msg = input.value.trim();
  if (!msg || !session) return;
  btn.disabled = true; input.disabled = true;
  try {
    const res = await fetch('/api/send-message', {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({sessionId: session.sessionId, message: msg})
    });
    const text = await res.text();
    const data = text ? JSON.parse(text) : {};
    if (res.ok && data.status === 'sent') {
      input.value = '';
      showToast('success','Sent','Message sent');
      setTimeout(() => refreshTranscript(session.sessionId), 1500);
    } else {
      showToast('error','Error', data.error || 'Failed to send');
    }
  } catch(e) { showToast('error','Error',e.message); }
  btn.disabled = false; input.disabled = false;
}

async function init() {
  try {
    let d;
    for (let attempt = 0; attempt < 3; attempt++) {
      try {
        const r = await fetch('/data/sessions.json?t=' + Date.now());
        if (!r.ok) { if (attempt < 2) { await new Promise(r => setTimeout(r, 500)); continue; } throw new Error(`HTTP ${r.status}`); }
        const txt = await r.text();
        if (!txt) { if (attempt < 2) { await new Promise(r => setTimeout(r, 500)); continue; } throw new Error('Empty response'); }
        d = JSON.parse(txt);
        break;
      } catch(e) { if (attempt >= 2) throw e; await new Promise(r => setTimeout(r, 500)); }
    }
    allSessions = d.sessions || [];
    if (d.topicNames) topicNamesMap = d.topicNames;
    session = allSessions.find(s => s.key === sessionKey);

    if (!session) {
      document.getElementById('sessionTitle').textContent = 'session not found';
      document.getElementById('logContainer').innerHTML = `<div class="loading">key: ${escapeHtml(sessionKey)}<br>not found in active sessions.</div>`;
      return;
    }

    document.getElementById('sessionTitle').textContent = getSessionName(session);
    document.title = getSessionName(session) + ' — OpenClaw';
    document.getElementById('sessionMeta').innerHTML = `
      <span>${session.channel || '—'}</span>
      <span>${session.sessionId?.slice(0, 8) || '—'}</span>
      <span>${formatTime(session.updatedAt)} ago</span>
      <span class="badge badge-${session.sessionType || 'other'}">${formatBadgeLabel(session.sessionType || 'other')}</span>
      ${session.totalTokens ? `<span>${(session.totalTokens/1000).toFixed(1)}k tok</span>` : ''}
      ${session.model ? `<span>${session.model.split('/').pop()}</span>` : ''}
    `;

    const isMain = session.key.endsWith(':main');
    const hasSubagents = isMain
      ? allSessions.some(s => s.sessionType === 'subagent')
      : (session.children || []).some(c => c.key?.includes(':subagent:')) ||
        allSessions.some(s => s.sessionType === 'subagent' && s.parentKey === session.key);
    if (hasSubagents) document.getElementById('panelTabs').style.display = '';

    await loadTranscript(session.sessionId);
    setInterval(() => refreshTranscript(session.sessionId), 3000);
  } catch(e) {
    document.getElementById('logContainer').innerHTML = `<div class="loading">error: ${e.message}</div>`;
  }
}

init();
</script>
</body>
</html>